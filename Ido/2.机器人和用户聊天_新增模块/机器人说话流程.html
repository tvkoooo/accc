<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>机器人说话流程</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="cndp" id="机器人说话流程">机器人说话流程</h1><div class="md-section-divider"></div><h2 data-anchor-id="0t7k" id="需要用到配置常量">需要用到配置常量</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dqst"><ol class="linenums"><li class="L0"><code><span class="pln">ROBOT_TALK_INTERVAL_TIME    </span><span class="lit">230</span><span class="pln"> </span><span class="lit">1</span><span class="pln">       </span><span class="lit">0</span><span class="pln">   </span><span class="pun">分钟</span></code></li><li class="L1"><code><span class="pln">ROBOT_TALK_GIFT_MIN_GOLD    </span><span class="lit">231</span><span class="pln"> </span><span class="lit">5000</span><span class="pln">    </span><span class="lit">0</span><span class="pln">   </span><span class="pun">金币</span></code></li><li class="L2"><code><span class="pln">ROBOT_TALK_AGAIN_FREQUENCY  </span><span class="lit">232</span><span class="pln"> </span><span class="lit">20</span><span class="pln">      </span><span class="lit">0</span><span class="pln">   </span><span class="pun">触发点（概率</span><span class="lit">1</span><span class="pun">/</span><span class="lit">20</span><span class="pun">）</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="6jxi" id="mysql的数据结构">mysql的数据结构</h2><p data-anchor-id="o0vj">talk_topic（采用数字计数；1代表普通类；2代表新人进场；3礼物语）</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="w4b9"><ol class="linenums"><li class="L0"><code><span class="com">/*!40101 DROP TABLE IF EXISTS `t_robot_talking_base`*/</span><span class="pun">;</span></code></li><li class="L1"><code><span class="com">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="pun">;</span></code></li><li class="L2"><code><span class="com">/*!40101 SET character_set_client = utf8 */</span><span class="pun">;</span></code></li><li class="L3"><code><span class="pln">CREATE TABLE </span><span class="str">`t_robot_talking_base`</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">`talk_id`</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">(</span><span class="lit">11</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> NOT NULL AUTO_INCREMENT comment </span><span class="str">'语句id'</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">    </span><span class="str">`talk_topic`</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">(</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> NOT NULL  comment </span><span class="str">'用户话题，采用数字计数；1代表普通类；2代表新人进场；3礼物语'</span><span class="pun">,</span></code></li><li class="L6"><code><span class="pln">    </span><span class="str">`talk_string`</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">(</span><span class="lit">100</span><span class="pun">)</span><span class="pln"> NOT NULL  comment </span><span class="str">'说话内容'</span><span class="pun">,</span></code></li><li class="L7"><code><span class="pln">    PRIMARY KEY </span><span class="pun">(</span><span class="str">`talk_id`</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pun">)</span><span class="pln"> ENGINE</span><span class="pun">=</span><span class="typ">InnoDB</span><span class="pln"> AUTO_INCREMENT</span><span class="pun">=</span><span class="lit">52010000</span><span class="pln"> DEFAULT CHARSET</span><span class="pun">=</span><span class="pln">utf8 comment</span><span class="pun">=</span><span class="str">'用户配置数据表'</span><span class="pun">;</span></code></li><li class="L9"><code><span class="com">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="pun">;</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="8xkd" id="redis的数据结构">Redis的数据结构</h2><div class="md-section-divider"></div><h3 data-anchor-id="rv24" id="1-redis-缓存talktopic话语hash结构-redistalk">1. redis 缓存talk_topic话语hash结构：  redis_talk</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="vxgm"><ol class="linenums"><li class="L0"><code><span class="pun">(</span><span class="pln">redis</span><span class="pun">)</span><span class="pln">hash robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">mysql</span><span class="pun">:</span><span class="pln">hash</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">(</span><span class="pln">uint32 talk_topic</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    f</span><span class="pun">(</span><span class="pln">uint32 talk_id</span><span class="pun">),</span></code></li><li class="L3"><code><span class="pln">    v</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> talk_string</span><span class="pun">),</span></code></li><li class="L4"><code><span class="pun">}</span></code></li><li class="L5"><code><span class="pun">(</span><span class="pln">cache</span><span class="pun">)</span><span class="pln">EXPIRE </span><span class="lit">3600</span><span class="pun">;</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="0qhr" id="2-redis-缓存talktopic索引set结构-redistalkindex">2. redis 缓存talk_topic索引set结构： redis_talkindex</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="22ny"><ol class="linenums"><li class="L0"><code><span class="pun">(</span><span class="pln">redis</span><span class="pun">)</span><span class="kwd">set</span><span class="pln"> robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">mysql</span><span class="pun">:</span><span class="kwd">set</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">(</span><span class="pln">uint32 talk_topic</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    k</span><span class="pun">(</span><span class="pln">uint32 talk_id</span><span class="pun">),</span></code></li><li class="L3"><code><span class="pun">}</span></code></li><li class="L4"><code><span class="pun">(</span><span class="pln">cache</span><span class="pun">)</span><span class="pln">EXPIRE </span><span class="lit">3600</span><span class="pun">;</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="s0d5" id="3-redis-所有房间房间内任意用户最后一次说话时间点hash结构-redistime">3. redis 所有房间，房间内任意用户最后一次说话时间点hash结构： redis_time</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="askf"><ol class="linenums"><li class="L0"><code><span class="pun">(</span><span class="pln">redis</span><span class="pun">)</span><span class="pln">hash robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">room</span><span class="pun">:</span><span class="pln">lasttalk</span><span class="pun">:</span><span class="pln">hash</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    f</span><span class="pun">(</span><span class="pln">uint32 sid</span><span class="pun">(房间号)),</span></code></li><li class="L3"><code><span class="pln">    v</span><span class="pun">(</span><span class="pln">uint32 timecode_now</span><span class="pun">),</span></code></li><li class="L4"><code><span class="pun">}</span></code></li><li class="L5"><code><span class="pun">(</span><span class="pln">cache</span><span class="pun">)</span><span class="pln">EXPIRE </span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span><span class="com">//主播退出，移除相应f</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="h3ek" id="4-redis-缓存-redisrobot-机器人zset结构-redisrobot">4. redis 缓存 redis_robot 机器人zset结构： redis_robot</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="msxp"><ol class="linenums"><li class="L0"><code><span class="pun">(</span><span class="pln">redis</span><span class="pun">)</span><span class="pln">zset robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">room</span><span class="pun">:</span><span class="pln">member</span><span class="pun">:</span><span class="pln">zset</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">（</span><span class="pln">uint32 </span><span class="pun">房间号</span><span class="pln"> </span><span class="pun">）</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    k</span><span class="pun">(</span><span class="pln">uint32 uid</span><span class="pun">(用户号)),</span></code></li><li class="L3"><code><span class="pln">    score</span><span class="pun">(</span><span class="pln">uint32 timecode_now</span><span class="pun">),</span></code></li><li class="L4"><code><span class="pun">}</span></code></li><li class="L5"><code><span class="pun">(</span><span class="pln">cache</span><span class="pun">)</span><span class="pln">EXPIRE </span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span><span class="com">//主播退出房间后删除键</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="sh32" id="5-redis-缓存-redisnewuser-新人zset结构-redisnewuser">5. redis 缓存 redis_newuser 新人zset结构： redis_newuser</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="j4ke"><ol class="linenums"><li class="L0"><code><span class="pun">(</span><span class="pln">redis</span><span class="pun">)</span><span class="pln">zset robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">newuser</span><span class="pun">:</span><span class="pln">member</span><span class="pun">:</span><span class="pln">zset</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">（</span><span class="pln">uint32 </span><span class="pun">房间号）</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    k</span><span class="pun">(</span><span class="pln">uint32 uid</span><span class="pun">(用户号)),</span></code></li><li class="L3"><code><span class="pln">    score</span><span class="pun">(</span><span class="pln">uint32 timecode_now</span><span class="pun">),</span></code></li><li class="L4"><code><span class="pun">}</span></code></li><li class="L5"><code><span class="pun">(</span><span class="pln">cache</span><span class="pun">)</span><span class="pln">EXPIRE </span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span><span class="com">//主播退出房间后删除</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="mmz6" id="6-redis-缓存-redisgift-礼物zset结构redisgift">6. redis 缓存 redis_gift 礼物zset结构：redis_gift</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ud03"><ol class="linenums"><li class="L0"><code><span class="pln">redis </span><span class="pun">缓存</span><span class="pln"> redis_gift </span><span class="pun">礼物</span><span class="pln">zset</span><span class="pun">结构：</span><span class="pln">redis_gift</span></code></li><li class="L1"><code><span class="pun">(</span><span class="pln">redis</span><span class="pun">)</span><span class="pln">zset robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">newuser</span><span class="pun">:</span><span class="pln">member</span><span class="pun">:</span><span class="pln">zset</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">（</span><span class="pln">uint32 </span><span class="pun">房间号）</span></code></li><li class="L2"><code><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">    k</span><span class="pun">(</span><span class="pln">uint32 timecode_now</span><span class="pun">),</span><span class="com">//这是个不重复的事件记录，只用于延时计数</span></code></li><li class="L4"><code><span class="pln">    score</span><span class="pun">(</span><span class="pln">uint32 timecode_now</span><span class="pun">),</span></code></li><li class="L5"><code><span class="pun">}</span></code></li><li class="L6"><code><span class="pun">(</span><span class="pln">cache</span><span class="pun">)</span><span class="pln">EXPIRE </span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span><span class="com">//主播退出房间后删除</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="7m1f" id="逻辑流程">逻辑流程</h2><div class="md-section-divider"></div><h3 data-anchor-id="msvl" id="1redis-更新-talk-和-talkindex-的数据">1.redis 更新 talk 和 talkindex 的数据</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="p6tg"><ol class="linenums"><li class="L0"><code><span class="pun">去数据库</span><span class="kwd">select</span><span class="pln"> </span><span class="pun">数据表</span><span class="pln">cms_manager</span><span class="pun">.</span><span class="pln">t_robot_talking_base</span><span class="pun">，放入</span><span class="pln">redis</span><span class="pun">。</span></code></li><li class="L1"><code><span class="pun">刷新数据库的人，需要删除</span><span class="pln"> talk </span><span class="pun">或者</span><span class="pln"> talkindex </span><span class="pun">缓存，让系统自己刷新（或者自己维护</span><span class="pln">redis</span><span class="pun">缓存）</span></code></li><li class="L2"><code><span class="kwd">del</span><span class="pln"> robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">mysql</span><span class="pun">:</span><span class="pln">hash</span><span class="pun">:</span><span class="lit">1</span><span class="pln">  </span><span class="pun">删除普通话</span><span class="pln">redis</span></code></li><li class="L3"><code><span class="kwd">del</span><span class="pln"> robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">mysql</span><span class="pun">:</span><span class="pln">hash</span><span class="pun">:</span><span class="lit">2</span><span class="pln">  </span><span class="pun">删除新人</span><span class="pln">redis</span></code></li><li class="L4"><code><span class="kwd">del</span><span class="pln"> robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">mysql</span><span class="pun">:</span><span class="pln">hash</span><span class="pun">:</span><span class="lit">3</span><span class="pln">  </span><span class="pun">删除礼物语</span><span class="pln">redis</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="x1ri" id="2-redis-清空-talk-和-talkindex-的数据">2. redis 清空 talk 和 talkindex 的数据</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="6wlb"><ol class="linenums"><li class="L0"><code><span class="pun">移除对应话题的</span><span class="pln">talk</span><span class="pun">和</span><span class="pln">talkindex</span><span class="pun">的数据</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="ve3p" id="3-控制台-从redis-取出-说话内容-talking">3. 控制台  从redis 取出 说话内容 talking</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="pvch"><ol class="linenums"><li class="L0"><code><span class="pun">先查询缓存</span><span class="pln"> talk </span><span class="pun">或者</span><span class="pln"> talkindex </span><span class="pun">是否有数据（）</span></code></li><li class="L1"><code><span class="pln">   </span><span class="pun">如果其中一项无数据：</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">步骤</span><span class="lit">2.</span><span class="pln"> redis </span><span class="pun">清空</span><span class="pln"> talk </span><span class="pun">和</span><span class="pln"> talkindex </span><span class="pun">的数据</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">步骤</span><span class="lit">1.</span><span class="pln"> redis </span><span class="pun">更新</span><span class="pln"> talk </span><span class="pun">和</span><span class="pln"> talkindex </span><span class="pun">的数据</span></code></li><li class="L4"><code><span class="pln">   </span><span class="pun">如果都有数据：</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">步骤</span><span class="lit">1.</span><span class="pln"> talkindex </span><span class="pun">随机取出</span><span class="pln"> talk_id </span><span class="pun">;</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">步骤</span><span class="lit">2.</span><span class="pln"> talk</span><span class="pun">根据</span><span class="pln"> talk_id </span><span class="pun">取出</span><span class="pln"> </span><span class="pun">话语内容</span><span class="pln"> talking</span><span class="pun">。</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="yscw" id="4-redis-更新-robot-的数据">4. redis 更新 robot 的数据</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="twlx"><ol class="linenums"><li class="L0"><code><span class="pun">机器</span><span class="pln">id</span><span class="pun">：</span><span class="pln">info_user_id</span></code></li><li class="L1"><code><span class="pun">当前时刻：</span><span class="pln">timecode_now</span></code></li><li class="L2"><code><span class="pln">ZADD  robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">room</span><span class="pun">:</span><span class="pln">menmber</span><span class="pun">:</span><span class="pln">zset</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">（</span><span class="pln">uint32 </span><span class="pun">房间号）</span><span class="pln"> timecode_now  info_user_id</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="vjt6" id="5redis-更新-newuser-的数据">5.redis 更新 newuser 的数据</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="mki5"><ol class="linenums"><li class="L0"><code><span class="pun">新新用户</span><span class="pln">id</span><span class="pun">：</span><span class="pln">info_user_id</span></code></li><li class="L1"><code><span class="pun">当前时刻：</span><span class="pln">timecode_now</span></code></li><li class="L2"><code><span class="pln">ZADD  robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">room</span><span class="pun">:</span><span class="pln">menmber</span><span class="pun">:</span><span class="pln">zset</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">（</span><span class="pln">uint32 </span><span class="pun">房间号）</span><span class="pln"> timecode_now  info_user_id</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="ornc" id="4-redis-更新-gift-的数据">4. redis 更新 gift 的数据</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="csqj"><ol class="linenums"><li class="L0"><code><span class="pun">事</span><span class="pln">    </span><span class="pun">件：</span><span class="pln">timecode_now </span><span class="com">//这是个不重复的事件记录，只用于延时计数</span></code></li><li class="L1"><code><span class="pun">当前时刻：</span><span class="pln">timecode_now</span></code></li><li class="L2"><code><span class="pln">ZADD  robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">room</span><span class="pun">:</span><span class="pln">menmber</span><span class="pun">:</span><span class="pln">zset</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">（</span><span class="pln">uint32 </span><span class="pun">房间号）</span><span class="pln"> timecode_now  info_user_id</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="nx6g" id="6-控制台-从redis-取出-robot">6. 控制台  从redis 取出 robot</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="kc14"><ol class="linenums"><li class="L0"><code><span class="pun">取出第一个机器人</span><span class="pln">id</span><span class="pun">并返回</span></code></li><li class="L1"><code><span class="pln">zRange robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">robot</span><span class="pun">:</span><span class="pln">member</span><span class="pun">:</span><span class="pln">zset</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">（</span><span class="pln">uint32 </span><span class="pun">房间号）</span><span class="pln">  </span><span class="lit">0</span><span class="pln">   </span><span class="lit">0</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="ttp1" id="7-控制台-从redis-取出-newuser">7. 控制台  从redis 取出 newuser</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="v3oh"><ol class="linenums"><li class="L0"><code><span class="pun">取出第一个新人</span><span class="pln">id</span><span class="pun">并返回</span></code></li><li class="L1"><code><span class="pln">zRange robot</span><span class="pun">:</span><span class="pln">talk</span><span class="pun">:</span><span class="pln">robot</span><span class="pun">:</span><span class="pln">member</span><span class="pun">:</span><span class="pln">zset</span><span class="pun">:%</span><span class="pln">u</span><span class="pun">（</span><span class="pln">uint32 </span><span class="pun">房间号）</span><span class="pln">  </span><span class="lit">0</span><span class="pln">   </span><span class="lit">0</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="276x" id="8新人说话发送过程">8.新人说话发送过程</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="1o9j"><ol class="linenums"><li class="L0"><code><span class="pln">at</span><span class="pun">消息</span><span class="pln"> </span></code></li><li class="L1"><code><span class="kwd">params</span></code></li><li class="L2"><code><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">"cid"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">"receiver"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"用户10003986（主播用户昵称）"</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">    </span><span class="str">"roler"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">25</span><span class="pun">,</span></code></li><li class="L6"><code><span class="pln">    </span><span class="str">"sender"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"用户10003986"</span><span class="pun">（机器人用户昵称）,</span></code></li><li class="L7"><code><span class="pln">    </span><span class="str">"sid"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">102536</span><span class="pun">（房间号）,</span></code></li><li class="L8"><code><span class="pln">    </span><span class="str">"uid"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">10003986</span><span class="pun">（机器人用户</span><span class="pln">id</span><span class="pun">）,</span></code></li><li class="L9"><code><span class="pln">    </span><span class="str">"uid_onmic"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">10003986</span><span class="pun">（主播用户</span><span class="pln">id</span><span class="pun">）,</span></code></li><li class="L0"><code><span class="pln">    </span><span class="str">"usercount"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"cmd"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"PAtMessage"</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    </span><span class="str">"context"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"ttttt（说话内容）"</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">"fromNickname"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"yyy（机器人用户昵称）"</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">"fromUid"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">10003986</span><span class="pun">（机器人用户</span><span class="pln">id</span><span class="pun">）,</span></code></li><li class="L5"><code><span class="pln">    </span><span class="str">"singerid"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"10003986（主播id）"</span><span class="pun">,</span></code></li><li class="L6"><code><span class="pln">    </span><span class="str">""</span><span class="pun">:</span><span class="pln"> </span><span class="str">"xxx（目标用户昵称）"</span><span class="pun">,</span></code></li><li class="L7"><code><span class="pln">    </span><span class="str">"toUid"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"10005127（目标用户id）"</span></code></li><li class="L8"><code><span class="pun">}</span></code></li><li class="L9"><code><span class="pln">$return </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ToolApi</span><span class="pun">::</span><span class="pln">atMessage</span><span class="pun">(</span><span class="pln">$params</span><span class="pun">);</span></code></li><li class="L0"><code><span class="pun">返回结果</span><span class="pln"> </span><span class="pun">附加</span><span class="pln"> $return</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="cnci" id="9普通说话发送过程">9.普通说话发送过程</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="n1pw"><ol class="linenums"><li class="L0"><code><span class="pun">普通消息</span></code></li><li class="L1"><code><span class="kwd">params</span></code></li><li class="L2"><code><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">"cid"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">"receiver"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"用户10003986（主播用户昵称）"</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">    </span><span class="str">"roler"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">25</span><span class="pun">,</span></code></li><li class="L6"><code><span class="pln">    </span><span class="str">"sender"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"xxx"</span><span class="pun">（机器人用户昵称）,</span></code></li><li class="L7"><code><span class="pln">    </span><span class="str">"sid"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">102536</span><span class="pun">（房间号）,</span></code></li><li class="L8"><code><span class="pln">    </span><span class="str">"uid"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"10005127"</span><span class="pun">（机器人用户</span><span class="pln">id</span><span class="pun">）,</span></code></li><li class="L9"><code><span class="pln">    </span><span class="str">"uid_onmic"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">10003986</span><span class="pun">（主播用户</span><span class="pln">id</span><span class="pun">）,</span></code></li><li class="L0"><code><span class="pln">    </span><span class="str">"usercount"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"cmd"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"PTextChat"</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    </span><span class="str">"context"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"她"</span><span class="pun">（说话内容）,</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">"singerid"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"10003986"</span><span class="pun">（主播</span><span class="pln">id</span><span class="pun">）</span></code></li><li class="L4"><code><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">$return </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ToolApi</span><span class="pun">::</span><span class="pln">textChat</span><span class="pun">(</span><span class="pln">$params</span><span class="pun">);</span></code></li><li class="L6"><code><span class="pun">返回结果</span><span class="pln"> </span><span class="pun">附加</span><span class="pln"> $return</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="9rto" id="10控制台合成新人说话内容提交到新人说话发送">10.控制台合成新人说话内容提交到【新人说话发送】</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="7cfe"><ol class="linenums"><li class="L0"><code><span class="pun">控制台</span><span class="pln">  </span><span class="pun">从</span><span class="pln">redis </span><span class="pun">取出</span><span class="pln"> </span><span class="pun">说话内容</span><span class="pln">talking</span></code></li><li class="L1"><code><span class="pun">控制台</span><span class="pln">  </span><span class="pun">从</span><span class="pln">redis </span><span class="pun">取出</span><span class="pln"> robot</span><span class="pun">（机器人用户</span><span class="pln">id</span><span class="pun">），根据机器人用户</span><span class="pln">id</span><span class="pun">，获取机器人用户属性</span></code></li><li class="L2"><code><span class="pun">控制台</span><span class="pln">  </span><span class="pun">从</span><span class="pln">redis </span><span class="pun">取出</span><span class="pln"> robot</span><span class="pun">（新人用户</span><span class="pln">id</span><span class="pun">），根据新人用户</span><span class="pln">id</span><span class="pun">，获取新人用户属性</span></code></li><li class="L3"><code><span class="pun">新人说话发送过程</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="habk" id="11用户新人-和-机器人-入场登记">11.用户（新人 和 机器人 ）入场登记</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="nlkk"><ol class="linenums"><li class="L0"><code><span class="pun">如果判断是机器人：</span><span class="pln">redis </span><span class="pun">更新</span><span class="pln"> robot </span><span class="pun">的数据</span></code></li><li class="L1"><code><span class="pun">如果判断是新人：</span><span class="pln">redis </span><span class="pun">更新</span><span class="pln"> newuser </span><span class="pun">的数据</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="s3bj" id="12-用户新人-和-机器人-出场移除">12. 用户（新人 和 机器人 ）出场移除</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="rg7j"><ol class="linenums"><li class="L0"><code><span class="pun">移除：</span><span class="pln">redis </span><span class="pun">移除</span><span class="pln"> robot </span><span class="pun">的机器人</span><span class="pln">id</span><span class="pun">数据</span></code></li><li class="L1"><code><span class="pun">移除：</span><span class="pln">redis </span><span class="pun">移除</span><span class="pln"> newuser </span><span class="pun">的新人</span><span class="pln">id</span><span class="pun">数据</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="w63e" id="礼物的外部接口函数">//礼物的外部接口函数</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="5axy"><ol class="linenums"><li class="L0"><code><span class="pun">判断</span><span class="pln">redis</span><span class="pun">缓存</span><span class="pln">gift </span><span class="pun">数据是否有超过</span><span class="lit">3s</span><span class="pun">的房间号（</span><span class="pln">sid</span><span class="pun">）并执行一次说话</span></code></li><li class="L1"><code><span class="pln">redis </span><span class="pun">判断记录</span><span class="pln"> gift</span><span class="pun">的数据</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="o9k3" id="13-判断记录-gift的数据">13. 判断记录 gift的数据</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="3ipp"><ol class="linenums"><li class="L0"><code><span class="pun">情况</span><span class="lit">1</span><span class="pun">：单次送礼</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">设置金币</span><span class="pln">  </span><span class="pun">必定说话</span></code></li><li class="L1"><code><span class="pun">情况</span><span class="lit">2</span><span class="pun">：连送金币</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">设置金币，第一次说话必出现</span></code></li><li class="L2"><code><span class="pun">情况</span><span class="lit">3</span><span class="pun">：连送情况下，当一次说话后，后续说话随机出现，概率</span><span class="lit">1</span><span class="pun">/</span><span class="pln">ROBOT_TALK_AGAIN_FREQUENCY</span><span class="pun">。</span></code></li><li class="L3"><code><span class="pun">三种情况统一下步到：</span><span class="pln">redis </span><span class="pun">更新</span><span class="pln"> gift </span><span class="pun">的数据</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="ughx" id="14判断redis缓存gift房间号sid-数据是否有超过3s的情况并执行一次说话">14.判断redis缓存gift房间号（sid） 数据是否有超过3s的情况，并执行一次说话</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="oue3"><ol class="linenums"><li class="L0"><code><span class="pln">user_topic</span><span class="pun">=</span><span class="lit">3</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pun">判断缓存</span><span class="pln">gift</span><span class="pun">列表当中是否有超过</span><span class="lit">3</span><span class="pun">秒的数据：</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">如果没有，退出当前步骤</span></code></li><li class="L3"><code><span class="pln">    </span><span class="pun">如果有：</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">取出</span><span class="pln">redis</span><span class="pun">缓存</span><span class="pln">gift</span><span class="pun">第一个数据，用于进行说话，</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">控制台合成礼物语说话内容提交到[普通说话发送]</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">相应移除</span><span class="pln">redis</span><span class="pun">缓存</span><span class="pln">gift</span><span class="pun">第一个记录</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="rhx7" id="15控制台合成礼物语说话内容提交到普通说话发送">15.控制台合成礼物语说话内容提交到[普通说话发送]</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="c9i2"><ol class="linenums"><li class="L0"><code><span class="pln">user_topic</span><span class="pun">=</span><span class="lit">3</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pun">控制台</span><span class="pln">  </span><span class="pun">从</span><span class="pln">redis </span><span class="pun">取出</span><span class="pln"> robot</span><span class="pun">（机器人</span><span class="pln">id</span><span class="pun">），并获取机器人用户属性</span></code></li><li class="L2"><code><span class="pun">控制台</span><span class="pln">  </span><span class="pun">从</span><span class="pln">redis </span><span class="pun">取出</span><span class="pln"> </span><span class="pun">说话内容</span><span class="pln">talking</span><span class="pun">（说话内容）</span></code></li><li class="L3"><code><span class="pun">普通说话发送过程</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="q5t0" id="16判断redis缓存time-数据是否有超过60s的房间号sid如果有就提交到普通说话发送">16.判断redis缓存time 数据是否有超过60s的房间号（sid）,如果有就提交到[普通说话发送]</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="s7ck"><ol class="linenums"><li class="L0"><code><span class="pln">user_topic</span><span class="pun">=</span><span class="lit">1</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pun">取出本房间号最后</span><span class="pln"> </span><span class="pun">真人</span><span class="pln"> </span><span class="pun">说话时间，作为取出时间，</span></code></li><li class="L2"><code><span class="pun">查看</span><span class="pln"> </span><span class="pun">当前时间</span><span class="pln"> </span><span class="pun">作为当前时间，判断</span></code></li><li class="L3"><code><span class="pln">    </span><span class="pun">时间差（当前时间-取出时间）&gt;</span><span class="pln"> </span><span class="pun">设定时间</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">控制台</span><span class="pln">  </span><span class="pun">从</span><span class="pln">redis </span><span class="pun">取出</span><span class="pln"> robot</span><span class="pun">（机器人</span><span class="pln">id</span><span class="pun">），并获取机器人用户属性</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">控制台</span><span class="pln">  </span><span class="pun">从</span><span class="pln">redis </span><span class="pun">取出</span><span class="pln"> </span><span class="pun">说话内容</span><span class="pln">talking</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">普通说话发送过程</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="2djc" id="外部接口函数监听是否有真人在说话">//外部接口函数，监听是否有真人在说话</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="wpi1"><ol class="linenums"><li class="L0"><code><span class="pln">redis </span><span class="pun">更新</span><span class="pln"> time </span><span class="pun">的数据</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="1p5p" id="17redis-更新-time-的数据">17.redis 更新 time 的数据</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="cs0u"><ol class="linenums"><li class="L0"><code><span class="pun">判断是否是机器人，如果是，跳出该环节</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">如果不是机器人：</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">记录该房间号的真人说话时刻</span><span class="pln">listen_time</span><span class="pun">（用于后续比对）</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="sanx" id="18-主播入场流程主播信息房间号">18. 主播入场流程(主播信息,房间号)</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="bwqi"><ol class="linenums"><li class="L0"><code><span class="pun">主播入场，设置无人说话时间戳</span></code></li><li class="L1"><code><span class="pun">给</span><span class="pln">redis </span><span class="pun">更新</span><span class="pln"> time </span><span class="pun">的数据做初始值（初始时刻）</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="mos5" id="19主播离场流程主播信息房间号">19.主播离场流程(主播信息,房间号)</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="05zg"><ol class="linenums"><li class="L0"><code><span class="pun">删掉该房间</span><span class="pln">sid </span><span class="pun">的机器人缓存</span><span class="pln"> redis_robot</span></code></li><li class="L1"><code><span class="pun">删掉该房间</span><span class="pln">sid </span><span class="pun">的新人缓存</span><span class="pln"> redis_newuser</span></code></li><li class="L2"><code><span class="pun">删掉该房间</span><span class="pln">sid </span><span class="pun">的礼物事件缓存</span><span class="pln"> redis_gift</span></code></li><li class="L3"><code><span class="pun">移除真人</span><span class="pln"> </span><span class="pun">最后说话</span><span class="pln"> </span><span class="pun">缓存</span><span class="pln">  </span><span class="pun">的</span><span class="pln">  </span><span class="pun">房间</span><span class="pln"> sid</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="kcp8" id="20判断redis缓存newuser-数据是否有超过3s的房间号sid并执行一次说话">20.判断redis缓存newuser 数据是否有超过3s的房间号（sid）并执行一次说话</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="v3ia"><ol class="linenums"><li class="L0"><code><span class="pun">判断缓</span><span class="pln">newuser </span><span class="pun">数据</span><span class="pln"> </span><span class="pun">当中是否有超过</span><span class="lit">3</span><span class="pun">秒的数据</span></code></li><li class="L1"><code><span class="pun">控制台合成新人说话内容提交到[新人说话发送]</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="xhxk" id="接口chanelapi直播间事件接口接入frontcontrolphp">接口chanel_api(直播间事件接口,接入FrontControl.php)</h2><div class="md-section-divider"></div><h3 data-anchor-id="iqgt" id="1用户进入直播间事件">1.用户进入直播间事件</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="azws"><ol class="linenums"><li class="L0"><code><span class="pun">是否有超过</span><span class="lit">3s</span><span class="pun">的新人数据,如果有，去执行说话</span></code></li><li class="L1"><code><span class="pun">触发机器人说话的入场流程</span></code></li><li class="L2"><code><span class="pun">用户（新人</span><span class="pln"> </span><span class="pun">和</span><span class="pln"> </span><span class="pun">机器人</span><span class="pln"> </span><span class="pun">）入场登记</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="94c0" id="2用户离开直播间事件">2.用户离开直播间事件</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="uu8w"><ol class="linenums"><li class="L0"><code><span class="pun">用户（新人</span><span class="pln"> </span><span class="pun">和</span><span class="pln"> </span><span class="pun">机器人</span><span class="pln"> </span><span class="pun">）出场移除</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="o6ys" id="3心跳触发事件5s次">3.心跳触发事件（5s/次）</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="vlk0"><ol class="linenums"><li class="L0"><code><span class="pun">判断</span><span class="pln">redis</span><span class="pun">缓存</span><span class="pln">time </span><span class="pun">数据是否有超过</span><span class="lit">60s</span><span class="pun">的房间号（</span><span class="pln">sid</span><span class="pun">）,如果有就提交到[普通说话发送]</span></code></li><li class="L1"><code><span class="pun">判断</span><span class="pln">redis</span><span class="pun">缓存</span><span class="pln">newuser </span><span class="pun">数据是否有超过</span><span class="lit">3s</span><span class="pun">的房间号（</span><span class="pln">sid</span><span class="pun">）如果有，内容提交到[控制台合成新人说话]</span></code></li><li class="L2"><code><span class="pun">判断</span><span class="pln">redis</span><span class="pun">缓存</span><span class="pln">gift </span><span class="pun">数据是否有超过</span><span class="lit">3s</span><span class="pun">的房间号（</span><span class="pln">sid</span><span class="pun">）并执行一次说话</span></code></li></ol></pre></div>
</body>
</html>